<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰åç«¯é›†æˆæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #666;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }
        .status.pass {
            background: #28a745;
            color: white;
        }
        .status.fail {
            background: #dc3545;
            color: white;
        }
        .stats {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ”¿åºœæ•ˆèƒ½ç£æŸ¥ç³»ç»Ÿ - å‰åç«¯é›†æˆæµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>ğŸ”§ è¿é€šæ€§æµ‹è¯•</h3>
            <button onclick="testHealth()">å¥åº·æ£€æŸ¥</button>
            <button onclick="testPing()">Pingæµ‹è¯•</button>
            <div id="connectivity-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ” è®¤è¯æµ‹è¯•</h3>
            <button onclick="testLogin()">ç”¨æˆ·ç™»å½•</button>
            <button onclick="testCurrentUser()">è·å–å½“å‰ç”¨æˆ·</button>
            <div id="auth-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“‹ ç£åŠäº‹é¡¹APIæµ‹è¯•</h3>
            <button onclick="testSupervisionList()">è·å–ç£åŠåˆ—è¡¨</button>
            <button onclick="testCreateSupervision()">åˆ›å»ºç£åŠäº‹é¡¹</button>
            <button onclick="testSupervisionDetail()">è·å–ç£åŠè¯¦æƒ…</button>
            <div id="supervision-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>âš™ï¸ å·¥ä½œæµAPIæµ‹è¯•</h3>
            <button onclick="testWorkflowTemplates()">å·¥ä½œæµæ¨¡æ¿</button>
            <button onclick="testMyTasks()">æˆ‘çš„ä»»åŠ¡</button>
            <div id="workflow-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š ç›‘æ§åˆ†æAPIæµ‹è¯•</h3>
            <button onclick="testMonitoringStats()">ç›‘æ§ç»Ÿè®¡</button>
            <button onclick="testAnalyticsOverview()">åˆ†ææ¦‚è§ˆ</button>
            <div id="monitoring-result" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸš€ æ‰¹é‡æµ‹è¯•</h3>
            <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        </div>
        
        <div class="stats" id="test-stats">
            <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•</p>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api/v1';
        let accessToken = null;
        let testResults = [];

        // å·¥å…·å‡½æ•°
        function logResult(section, testName, success, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const status = success ? 'PASS' : 'FAIL';
            const statusClass = success ? 'pass' : 'fail';
            
            let logMessage = `[${timestamp}] <span class="status ${statusClass}">${status}</span> ${testName}`;
            if (message) logMessage += `: ${message}`;
            if (data) logMessage += `\næ•°æ®: ${JSON.stringify(data, null, 2)}`;
            
            const resultDiv = document.getElementById(`${section}-result`);
            resultDiv.innerHTML += logMessage + '\n\n';
            resultDiv.className = `result ${success ? 'success' : 'error'}`;
            
            testResults.push({ section, testName, success, message, timestamp });
            updateStats();
        }

        function updateStats() {
            const total = testResults.length;
            const passed = testResults.filter(r => r.success).length;
            const failed = total - passed;
            
            const statsDiv = document.getElementById('test-stats');
            statsDiv.innerHTML = `
                <strong>æµ‹è¯•ç»Ÿè®¡:</strong> 
                æ€»è®¡ ${total} | 
                <span style="color: #28a745;">é€šè¿‡ ${passed}</span> | 
                <span style="color: #dc3545;">å¤±è´¥ ${failed}</span> | 
                æˆåŠŸç‡ ${total > 0 ? Math.round(passed/total*100) : 0}%
            `;
        }

        function clearResults() {
            const resultDivs = document.querySelectorAll('.result');
            resultDivs.forEach(div => {
                div.innerHTML = '';
                div.className = 'result';
            });
            testResults = [];
            updateStats();
        }

        // APIæµ‹è¯•å‡½æ•°
        async function makeRequest(url, options = {}) {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                if (accessToken) {
                    headers.Authorization = `Bearer ${accessToken}`;
                }

                const response = await fetch(url, {
                    ...options,
                    headers
                });

                const data = await response.json();
                return { success: response.ok, status: response.status, data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // è¿é€šæ€§æµ‹è¯•
        async function testHealth() {
            const result = await makeRequest('http://localhost:8000/health');
            if (result.success) {
                logResult('connectivity', 'å¥åº·æ£€æŸ¥', true, 'æœåŠ¡æ­£å¸¸è¿è¡Œ', result.data);
            } else {
                logResult('connectivity', 'å¥åº·æ£€æŸ¥', false, `è¿æ¥å¤±è´¥: ${result.error || result.status}`);
            }
        }

        async function testPing() {
            const result = await makeRequest(`${API_BASE_URL}/ping`);
            if (result.success) {
                logResult('connectivity', 'Pingæµ‹è¯•', true, 'è¿é€šæ€§æ­£å¸¸', result.data);
            } else {
                logResult('connectivity', 'Pingæµ‹è¯•', false, `è¯·æ±‚å¤±è´¥: ${result.error || result.status}`);
            }
        }

        // è®¤è¯æµ‹è¯•
        async function testLogin() {
            const loginData = {
                username: 'test_admin',
                password: 'test123456'
            };

            const result = await makeRequest(`${API_BASE_URL}/auth/login`, {
                method: 'POST',
                body: JSON.stringify(loginData)
            });

            if (result.success && result.data.data && result.data.data.access_token) {
                accessToken = result.data.data.access_token;
                logResult('auth', 'ç”¨æˆ·ç™»å½•', true, 'ç™»å½•æˆåŠŸï¼Œå·²è·å–token', {
                    user: result.data.data.user,
                    token: accessToken.substring(0, 20) + '...'
                });
            } else {
                logResult('auth', 'ç”¨æˆ·ç™»å½•', false, `ç™»å½•å¤±è´¥: ${result.error || result.data?.message || result.status}`);
            }
        }

        async function testCurrentUser() {
            if (!accessToken) {
                logResult('auth', 'è·å–å½“å‰ç”¨æˆ·', false, 'è¯·å…ˆç™»å½•è·å–token');
                return;
            }

            const result = await makeRequest(`${API_BASE_URL}/users/me`);
            if (result.success) {
                logResult('auth', 'è·å–å½“å‰ç”¨æˆ·', true, 'æˆåŠŸè·å–ç”¨æˆ·ä¿¡æ¯', result.data.data);
            } else {
                logResult('auth', 'è·å–å½“å‰ç”¨æˆ·', false, `è¯·æ±‚å¤±è´¥: ${result.error || result.status}`);
            }
        }

        // ç£åŠäº‹é¡¹æµ‹è¯•
        async function testSupervisionList() {
            const result = await makeRequest(`${API_BASE_URL}/supervision?page=1&size=10`);
            if (result.success) {
                const total = result.data.data.total;
                logResult('supervision', 'è·å–ç£åŠåˆ—è¡¨', true, `æˆåŠŸè·å– ${total} ä¸ªç£åŠäº‹é¡¹`, {
                    total,
                    items: result.data.data.items.length
                });
            } else {
                logResult('supervision', 'è·å–ç£åŠåˆ—è¡¨', false, `è¯·æ±‚å¤±è´¥: ${result.error || result.status}`);
            }
        }

        async function testCreateSupervision() {
            const newItem = {
                title: 'å‰ç«¯é›†æˆæµ‹è¯•ç£åŠäº‹é¡¹',
                content: 'è¿™æ˜¯é€šè¿‡å‰ç«¯é¡µé¢åˆ›å»ºçš„æµ‹è¯•ç£åŠäº‹é¡¹',
                type: 'regular',
                urgency: 'medium',
                deadline: '2025-08-30T23:59:59',
                source: 'å‰ç«¯é›†æˆæµ‹è¯•'
            };

            const result = await makeRequest(`${API_BASE_URL}/supervision`, {
                method: 'POST',
                body: JSON.stringify(newItem)
            });

            if (result.success) {
                const itemId = result.data.data.id;
                logResult('supervision', 'åˆ›å»ºç£åŠäº‹é¡¹', true, `æˆåŠŸåˆ›å»ºäº‹é¡¹ï¼ŒID: ${itemId}`, result.data.data);
            } else {
                logResult('supervision', 'åˆ›å»ºç£åŠäº‹é¡¹', false, `åˆ›å»ºå¤±è´¥: ${result.error || result.data?.message || result.status}`);
            }
        }

        async function testSupervisionDetail() {
            // å…ˆè·å–ä¸€ä¸ªç£åŠäº‹é¡¹ID
            const listResult = await makeRequest(`${API_BASE_URL}/supervision?page=1&size=1`);
            if (!listResult.success || !listResult.data.data.items.length) {
                logResult('supervision', 'è·å–ç£åŠè¯¦æƒ…', false, 'æ²¡æœ‰å¯ç”¨çš„ç£åŠäº‹é¡¹è¿›è¡Œæµ‹è¯•');
                return;
            }

            const itemId = listResult.data.data.items[0].id;
            const result = await makeRequest(`${API_BASE_URL}/supervision/${itemId}`);
            
            if (result.success) {
                logResult('supervision', 'è·å–ç£åŠè¯¦æƒ…', true, `æˆåŠŸè·å–äº‹é¡¹è¯¦æƒ…ï¼ŒID: ${itemId}`, result.data.data);
            } else {
                logResult('supervision', 'è·å–ç£åŠè¯¦æƒ…', false, `è¯·æ±‚å¤±è´¥: ${result.error || result.status}`);
            }
        }

        // å·¥ä½œæµæµ‹è¯•
        async function testWorkflowTemplates() {
            const result = await makeRequest(`${API_BASE_URL}/workflow/templates?page=1&size=10`);
            if (result.success) {
                const total = result.data.data.total;
                logResult('workflow', 'å·¥ä½œæµæ¨¡æ¿', true, `æˆåŠŸè·å– ${total} ä¸ªæ¨¡æ¿`, {
                    total,
                    items: result.data.data.items.length
                });
            } else {
                logResult('workflow', 'å·¥ä½œæµæ¨¡æ¿', false, `è¯·æ±‚å¤±è´¥: ${result.error || result.status}`);
            }
        }

        async function testMyTasks() {
            const result = await makeRequest(`${API_BASE_URL}/workflow/my-tasks?page=1&size=10`);
            if (result.success) {
                const total = result.data.data.total;
                logResult('workflow', 'æˆ‘çš„ä»»åŠ¡', true, `æˆåŠŸè·å– ${total} ä¸ªä»»åŠ¡`, {
                    total,
                    items: result.data.data.items.length
                });
            } else {
                logResult('workflow', 'æˆ‘çš„ä»»åŠ¡', false, `è¯·æ±‚å¤±è´¥: ${result.error || result.status}`);
            }
        }

        // ç›‘æ§åˆ†ææµ‹è¯•
        async function testMonitoringStats() {
            const result = await makeRequest(`${API_BASE_URL}/monitoring/stats`);
            if (result.success) {
                logResult('monitoring', 'ç›‘æ§ç»Ÿè®¡', true, 'æˆåŠŸè·å–ç›‘æ§ç»Ÿè®¡æ•°æ®', result.data.data);
            } else {
                logResult('monitoring', 'ç›‘æ§ç»Ÿè®¡', false, `è¯·æ±‚å¤±è´¥: ${result.error || result.status}`);
            }
        }

        async function testAnalyticsOverview() {
            const result = await makeRequest(`${API_BASE_URL}/analytics/overview?start_date=2025-01-01&end_date=2025-12-31`);
            if (result.success) {
                logResult('monitoring', 'åˆ†ææ¦‚è§ˆ', true, 'æˆåŠŸè·å–åˆ†ææ¦‚è§ˆæ•°æ®', result.data.data);
            } else {
                logResult('monitoring', 'åˆ†ææ¦‚è§ˆ', false, `è¯·æ±‚å¤±è´¥: ${result.error || result.status}`);
            }
        }

        // æ‰¹é‡æµ‹è¯•
        async function runAllTests() {
            clearResults();
            
            console.log('å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
            
            // è¿é€šæ€§æµ‹è¯•
            await testHealth();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testPing();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // è®¤è¯æµ‹è¯•
            await testLogin();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testCurrentUser();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // ç£åŠäº‹é¡¹æµ‹è¯•
            await testSupervisionList();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testCreateSupervision();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testSupervisionDetail();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // å·¥ä½œæµæµ‹è¯•
            await testWorkflowTemplates();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testMyTasks();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // ç›‘æ§åˆ†ææµ‹è¯•
            await testMonitoringStats();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testAnalyticsOverview();
            
            console.log('æ‰€æœ‰æµ‹è¯•å®Œæˆï¼');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œè‡ªåŠ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...');
            testHealth();
        };
    </script>
</body>
</html>